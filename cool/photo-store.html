<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPhoto - Your Private Photo Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .photo-item {
            transition: all 0.3s ease;
        }
        .photo-item:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .dropzone {
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .dropzone.active {
            border-color: #4F46E5;
            background-color: rgba(79, 70, 229, 0.05);
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .progress-bar {
            height: 4px;
            background-color: #4F46E5;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-camera-retro text-2xl"></i>
                    <h1 class="text-2xl font-bold">WebPhoto</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="hidden md:block">
                        <span class="text-indigo-100">Your photos stay private - stored only in your browser!</span>
                    </div>
                    <div class="flex space-x-2">
                        <button id="exportBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-file-export mr-2"></i>Export
                        </button>
                        <button id="importBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-file-import mr-2"></i>Import
                        </button>
                        <button id="clearAllBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-trash-alt mr-2"></i>Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="storageProgress" class="progress-bar"></div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Upload Section -->
        <section class="mb-12">
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Add Photos</h2>
                
                <div id="dropzone" class="dropzone p-8 text-center cursor-pointer mb-4">
                    <div class="flex flex-col items-center justify-center space-y-2">
                        <i class="fas fa-cloud-upload-alt text-4xl text-indigo-500"></i>
                        <p class="text-gray-600">Drag & drop photos here or click to browse</p>
                        <p class="text-sm text-gray-400">Supports JPG, PNG, GIF (Max 5MB each)</p>
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept="image/*" multiple>
                </div>
                
                <div class="flex flex-wrap gap-4">
                    <button id="uploadBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Add Photos
                    </button>
                    <button id="takePhotoBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition flex items-center">
                        <i class="fas fa-camera mr-2"></i> Take Photo
                    </button>
                </div>
            </div>
        </section>

        <!-- Filter/Search Section -->
        <section class="mb-8">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="searchInput" placeholder="Search photos by name or date..." 
                               class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex items-center space-x-4">
                        <div>
                            <label for="sortSelect" class="block text-sm font-medium text-gray-700 mb-1">Sort by</label>
                            <select id="sortSelect" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="date-desc">Newest first</option>
                                <option value="date-asc">Oldest first</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="size-desc">Largest first</option>
                                <option value="size-asc">Smallest first</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Photo Grid -->
        <section>
            <div id="photoCounter" class="text-gray-600 mb-4">
                Loading your photos...
            </div>
            
            <div id="photoGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <!-- Photos will be loaded here -->
            </div>
            
            <div id="emptyState" class="text-center py-12 hidden">
                <i class="fas fa-images text-5xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-medium text-gray-500">Your photo library is empty</h3>
                <p class="text-gray-400 mt-2">Add some photos to get started!</p>
            </div>
        </section>
    </main>

    <!-- Photo Modal -->
    <div id="photoModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="relative max-w-4xl w-full">
            <button id="closeModalBtn" class="absolute -top-10 right-0 text-white hover:text-gray-300">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <div class="bg-white rounded-lg overflow-hidden">
                <div class="flex flex-col md:flex-row">
                    <div class="md:w-2/3 bg-gray-900 flex items-center justify-center">
                        <img id="modalImage" src="" alt="Enlarged photo" class="max-h-[80vh] w-auto object-contain">
                    </div>
                    <div class="md:w-1/3 p-6">
                        <h3 id="modalTitle" class="text-xl font-semibold mb-4"></h3>
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-gray-500">Uploaded</p>
                                <p id="modalDate" class="text-gray-700"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Size</p>
                                <p id="modalSize" class="text-gray-700"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Dimensions</p>
                                <p id="modalDimensions" class="text-gray-700"></p>
                            </div>
                        </div>
                        <div class="mt-6 flex flex-wrap gap-2">
                            <button id="downloadBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm flex items-center">
                                <i class="fas fa-download mr-2"></i> Download
                            </button>
                            <button id="deleteBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm flex items-center">
                                <i class="fas fa-trash-alt mr-2"></i> Delete
                            </button>
                            <button id="shareBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm flex items-center">
                                <i class="fas fa-share-alt mr-2"></i> Share
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="relative bg-white rounded-lg p-6 max-w-md w-full">
            <button id="closeCameraBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-xl font-semibold mb-4">Take a Photo</h3>
            <div class="mb-4">
                <video id="cameraView" class="w-full bg-black rounded-lg" autoplay playsinline></video>
            </div>
            <div class="flex justify-center">
                <button id="captureBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-full">
                    <i class="fas fa-camera text-xl"></i>
                </button>
            </div>
            <div id="cameraPreview" class="mt-4 hidden">
                <canvas id="photoCanvas" class="w-full rounded-lg"></canvas>
                <div class="flex justify-center gap-4 mt-4">
                    <button id="retakeBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-redo mr-2"></i> Retake
                    </button>
                    <button id="savePhotoBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i> Save Photo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export/Import Modal -->
    <div id="exportImportModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="relative bg-white rounded-lg p-6 max-w-md w-full">
            <button id="closeExportImportBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 id="exportImportTitle" class="text-xl font-semibold mb-4">Export Photos</h3>
            <div id="exportContent" class="space-y-4">
                <p class="text-gray-600">Export your entire photo library as a backup file.</p>
                <button id="exportNowBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-file-export mr-2"></i> Export Now
                </button>
                <div id="exportResult" class="hidden mt-4 p-4 bg-gray-100 rounded-lg"></div>
            </div>
            <div id="importContent" class="space-y-4 hidden">
                <p class="text-gray-600">Import photos from a previously exported backup file.</p>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer">
                    <i class="fas fa-file-import text-4xl text-indigo-500 mb-2"></i>
                    <p class="text-gray-600">Click to select backup file or drag and drop</p>
                    <input type="file" id="importFileInput" class="hidden" accept=".json">
                </div>
                <div id="importProgress" class="hidden">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="importProgressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="importStatus" class="text-sm text-gray-600 mt-2">Processing...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
            <i id="toastIcon" class="fas fa-check-circle mr-3"></i>
            <span id="toastMessage">Operation completed successfully</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const dropzone = document.getElementById('dropzone');
            const photoGrid = document.getElementById('photoGrid');
            const emptyState = document.getElementById('emptyState');
            const photoCounter = document.getElementById('photoCounter');
            const searchInput = document.getElementById('searchInput');
            const sortSelect = document.getElementById('sortSelect');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const photoModal = document.getElementById('photoModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalDate = document.getElementById('modalDate');
            const modalSize = document.getElementById('modalSize');
            const modalDimensions = document.getElementById('modalDimensions');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const shareBtn = document.getElementById('shareBtn');
            const cameraModal = document.getElementById('cameraModal');
            const cameraView = document.getElementById('cameraView');
            const photoCanvas = document.getElementById('photoCanvas');
            const captureBtn = document.getElementById('captureBtn');
            const retakeBtn = document.getElementById('retakeBtn');
            const savePhotoBtn = document.getElementById('savePhotoBtn');
            const cameraPreview = document.getElementById('cameraPreview');
            const closeCameraBtn = document.getElementById('closeCameraBtn');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');
            const exportBtn = document.getElementById('exportBtn');
            const importBtn = document.getElementById('importBtn');
            const exportImportModal = document.getElementById('exportImportModal');
            const closeExportImportBtn = document.getElementById('closeExportImportBtn');
            const exportContent = document.getElementById('exportContent');
            const importContent = document.getElementById('importContent');
            const exportImportTitle = document.getElementById('exportImportTitle');
            const exportNowBtn = document.getElementById('exportNowBtn');
            const exportResult = document.getElementById('exportResult');
            const importFileInput = document.getElementById('importFileInput');
            const importProgress = document.getElementById('importProgress');
            const importProgressBar = document.getElementById('importProgressBar');
            const importStatus = document.getElementById('importStatus');
            const storageProgress = document.getElementById('storageProgress');

            // Current photo being viewed in modal
            let currentPhotoId = null;
            let stream = null;
            let db = null;
            const DB_NAME = 'WebPhotoDB';
            const STORE_NAME = 'photos';

            // Initialize the photo library
            initPhotoLibrary();

            // Event Listeners
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            
            dropzone.addEventListener('click', () => fileInput.click());
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('active');
            });
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('active');
            });
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('active');
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload();
                }
            });
            
            searchInput.addEventListener('input', filterPhotos);
            sortSelect.addEventListener('change', filterPhotos);
            clearAllBtn.addEventListener('click', clearAllPhotos);
            closeModalBtn.addEventListener('click', () => photoModal.classList.add('hidden'));
            downloadBtn.addEventListener('click', downloadPhoto);
            deleteBtn.addEventListener('click', deletePhoto);
            shareBtn.addEventListener('click', sharePhoto);
            
            takePhotoBtn.addEventListener('click', openCamera);
            closeCameraBtn.addEventListener('click', closeCamera);
            captureBtn.addEventListener('click', capturePhoto);
            retakeBtn.addEventListener('click', retakePhoto);
            savePhotoBtn.addEventListener('click', savePhoto);
            
            exportBtn.addEventListener('click', () => showExportImportModal('export'));
            importBtn.addEventListener('click', () => showExportImportModal('import'));
            closeExportImportBtn.addEventListener('click', () => exportImportModal.classList.add('hidden'));
            exportNowBtn.addEventListener('click', exportPhotos);
            importFileInput.addEventListener('change', handleImport);

            // Photo Modal click outside to close
            photoModal.addEventListener('click', (e) => {
                if (e.target === photoModal) {
                    photoModal.classList.add('hidden');
                }
            });

            // Camera Modal click outside to close
            cameraModal.addEventListener('click', (e) => {
                if (e.target === cameraModal) {
                    closeCamera();
                }
            });

            // Export/Import Modal click outside to close
            exportImportModal.addEventListener('click', (e) => {
                if (e.target === exportImportModal) {
                    exportImportModal.classList.add('hidden');
                }
            });

            // Initialize the photo library from storage
            function initPhotoLibrary() {
                initIndexedDB().then(() => {
                    loadPhotos();
                    updateStorageProgress();
                    
                    // Check if this is the first visit using a cookie
                    if (!document.cookie.includes('webphoto_visited=true')) {
                        showToast('Welcome to WebPhoto! Your photos are stored only in your browser.', 'info');
                        // Set cookie to expire in 1 year
                        document.cookie = 'webphoto_visited=true; max-age=' + 60*60*24*365;
                    }
                }).catch(err => {
                    console.error('IndexedDB initialization failed:', err);
                    showToast('Warning: Some storage features might not work properly', 'warning');
                    loadPhotos();
                });
            }

            // Initialize IndexedDB
            function initIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, 1);
                    
                    request.onerror = (event) => {
                        console.error('IndexedDB error:', event.target.error);
                        reject(event.target.error);
                    };
                    
                    request.onsuccess = (event) => {
                        db = event.target.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        }
                    };
                });
            }

            // Load photos from storage
            function loadPhotos() {
                // First try to get from localStorage
                const localStoragePhotos = JSON.parse(localStorage.getItem('webphoto_library')) || [];
                
                if (localStoragePhotos.length > 0) {
                    renderPhotos(localStoragePhotos);
                    updatePhotoCounter(localStoragePhotos.length);
                } else {
                    // If localStorage is empty, check IndexedDB
                    getPhotosFromIndexedDB().then(photos => {
                        if (photos.length > 0) {
                            // Migrate from IndexedDB to localStorage if possible
                            localStorage.setItem('webphoto_library', JSON.stringify(photos));
                            renderPhotos(photos);
                            updatePhotoCounter(photos.length);
                        } else {
                            // No photos in either storage
                            renderPhotos([]);
                            updatePhotoCounter(0);
                        }
                    }).catch(err => {
                        console.error('Error loading from IndexedDB:', err);
                        renderPhotos([]);
                        updatePhotoCounter(0);
                    });
                }
            }

            // Get photos from IndexedDB
            function getPhotosFromIndexedDB() {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        resolve([]);
                        return;
                    }
                    
                    const transaction = db.transaction(STORE_NAME, 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        resolve(request.result || []);
                    };
                    
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            // Save photo to storage
            function savePhotoToLibrary(photoData) {
                return new Promise((resolve, reject) => {
                    const photoId = Date.now().toString();
                    const photo = {
                        id: photoId,
                        ...photoData
                    };
                    
                    // First try to save to localStorage
                    try {
                        const photos = JSON.parse(localStorage.getItem('webphoto_library')) || [];
                        photos.unshift(photo);
                        localStorage.setItem('webphoto_library', JSON.stringify(photos));
                        resolve(photoId);
                    } catch (error) {
                        console.warn('LocalStorage full, trying IndexedDB:', error);
                        
                        // If localStorage fails, use IndexedDB
                        if (db) {
                            const transaction = db.transaction(STORE_NAME, 'readwrite');
                            const store = transaction.objectStore(STORE_NAME);
                            const request = store.add(photo);
                            
                            request.onsuccess = () => {
                                resolve(photoId);
                            };
                            
                            request.onerror = (event) => {
                                reject(event.target.error);
                            };
                        } else {
                            reject(new Error('No storage available'));
                        }
                    }
                });
            }

            // Delete photo from storage
            function deletePhotoFromLibrary(photoId) {
                return new Promise((resolve, reject) => {
                    // First try to delete from localStorage
                    try {
                        const photos = JSON.parse(localStorage.getItem('webphoto_library')) || [];
                        const updatedPhotos = photos.filter(p => p.id !== photoId);
                        localStorage.setItem('webphoto_library', JSON.stringify(updatedPhotos));
                        
                        // Also try to delete from IndexedDB if it exists there
                        if (db) {
                            const transaction = db.transaction(STORE_NAME, 'readwrite');
                            const store = transaction.objectStore(STORE_NAME);
                            store.delete(photoId);
                        }
                        
                        resolve();
                    } catch (error) {
                        console.error('Error deleting photo:', error);
                        reject(error);
                    }
                });
            }

            // Render photos to the grid
            function renderPhotos(photos) {
                photoGrid.innerHTML = '';
                
                if (photos.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                // Process photos in chunks to avoid UI freezing
                const chunkSize = 10;
                let index = 0;
                
                function processChunk() {
                    const chunk = photos.slice(index, index + chunkSize);
                    
                    chunk.forEach(photo => {
                        const photoItem = document.createElement('div');
                        photoItem.className = 'photo-item bg-white rounded-lg overflow-hidden shadow-md fade-in';
                        photoItem.innerHTML = `
                            <div class="relative pb-[100%]">
                                <img src="${photo.dataUrl}" alt="${photo.name}" 
                                    class="absolute h-full w-full object-cover cursor-pointer"
                                    data-id="${photo.id}">
                                <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center opacity-0 hover:opacity-100">
                                    <button class="view-btn bg-white bg-opacity-80 hover:bg-opacity-100 text-gray-800 p-2 rounded-full" data-id="${photo.id}">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="p-3">
                                <p class="text-sm font-medium text-gray-800 truncate">${photo.name}</p>
                                <p class="text-xs text-gray-500">${formatDate(photo.date)} • ${formatFileSize(photo.size)}</p>
                            </div>
                        `;
                        photoGrid.appendChild(photoItem);
                    });
                    
                    index += chunkSize;
                    
                    if (index < photos.length) {
                        setTimeout(processChunk, 50);
                    } else {
                        // Add event listeners to all view buttons
                        document.querySelectorAll('.view-btn, .photo-item img').forEach(el => {
                            el.addEventListener('click', (e) => {
                                const photoId = e.currentTarget.getAttribute('data-id');
                                viewPhoto(photoId);
                            });
                        });
                    }
                }
                
                processChunk();
            }

            // Handle file upload
            function handleFileUpload() {
                const files = fileInput.files;
                if (files.length === 0) return;
                
                let photosAdded = 0;
                let errors = [];
                
                Array.from(files).forEach(file => {
                    if (!file.type.match('image.*')) {
                        errors.push(`${file.name} is not an image file`);
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        errors.push(`${file.name} is too large (max 5MB)`);
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            savePhotoToLibrary({
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                dataUrl: e.target.result,
                                width: img.width,
                                height: img.height,
                                date: new Date().toISOString()
                            }).then(() => {
                                photosAdded++;
                                
                                if (photosAdded + errors.length === files.length) {
                                    if (photosAdded > 0) {
                                        showToast(`Added ${photosAdded} photo(s) to your library`, 'success');
                                        loadPhotos();
                                        updateStorageProgress();
                                    }
                                    if (errors.length > 0) {
                                        showToast(`${errors.length} file(s) couldn't be added: ${errors.join(', ')}`, 'error');
                                    }
                                }
                            }).catch(err => {
                                errors.push(`${file.name} couldn't be saved (storage full?)`);
                                if (photosAdded + errors.length === files.length) {
                                    showToast(`${errors.length} file(s) couldn't be added: ${errors.join(', ')}`, 'error');
                                }
                            });
                        };
                        img.onerror = function() {
                            errors.push(`${file.name} couldn't be loaded`);
                            if (photosAdded + errors.length === files.length) {
                                showToast(`${errors.length} file(s) couldn't be added: ${errors.join(', ')}`, 'error');
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.onerror = function() {
                        errors.push(`${file.name} couldn't be read`);
                        if (photosAdded + errors.length === files.length) {
                            showToast(`${errors.length} file(s) couldn't be added: ${errors.join(', ')}`, 'error');
                        }
                    };
                    reader.readAsDataURL(file);
                });
                
                // Reset file input
                fileInput.value = '';
            }

            // View photo in modal
            function viewPhoto(photoId) {
                // First check localStorage
                const localStoragePhotos = JSON.parse(localStorage.getItem('webphoto_library')) || [];
                let photo = localStoragePhotos.find(p => p.id === photoId);
                
                if (photo) {
                    displayPhotoInModal(photo);
                    return;
                }
                
                // If not found in localStorage, check IndexedDB
                if (db) {
                    const transaction = db.transaction(STORE_NAME, 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(photoId);
                    
                    request.onsuccess = () => {
                        if (request.result) {
                            displayPhotoInModal(request.result);
                        } else {
                            showToast('Photo not found', 'error');
                        }
                    };
                    
                    request.onerror = (event) => {
                        showToast('Error loading photo', 'error');
                        console.error('IndexedDB error:', event.target.error);
                    };
                } else {
                    showToast('Photo not found', 'error');
                }
            }

            // Display photo in modal
            function displayPhotoInModal(photo) {
                currentPhotoId = photo.id;
                modalImage.src = photo.dataUrl;
                modalTitle.textContent = photo.name;
                modalDate.textContent = formatDate(photo.date, true);
                modalSize.textContent = formatFileSize(photo.size);
                modalDimensions.textContent = `${photo.width} × ${photo.height} pixels`;
                
                photoModal.classList.remove('hidden');
            }

            // Download photo
            function downloadPhoto() {
                if (!currentPhotoId) return;
                
                // First check localStorage
                const localStoragePhotos = JSON.parse(localStorage.getItem('webphoto_library')) || [];
                let photo = localStoragePhotos.find(p => p.id === currentPhotoId);
                
                if (photo) {
                    downloadPhotoFile(photo);
                    return;
                }
                
                // If not found in localStorage, check IndexedDB
                if (db) {
                    const transaction = db.transaction(STORE_NAME, 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(currentPhotoId);
                    
                    request.onsuccess = () => {
                        if (request.result) {
                            downloadPhotoFile(request.result);
                        } else {
                            showToast('Photo not found', 'error');
                        }
                    };
                    
                    request.onerror = (event) => {
                        showToast('Error loading photo', 'error');
                        console.error('IndexedDB error:', event.target.error);
                    };
                } else {
                    showToast('Photo not found', 'error');
                }
            }

            // Helper to download photo file
            function downloadPhotoFile(photo) {
                const link = document.createElement('a');
                link.href = photo.dataUrl;
                link.download = photo.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Download started', 'success');
            }

            // Delete photo
            function deletePhoto() {
                if (!currentPhotoId) return;
                
                if (!confirm('Are you sure you want to delete this photo?')) {
                    return;
                }
                
                deletePhotoFromLibrary(currentPhotoId)
                    .then(() => {
                        photoModal.classList.add('hidden');
                        loadPhotos();
                        updateStorageProgress();
                        showToast('Photo deleted', 'success');
                    })
                    .catch(err => {
                        console.error('Error deleting photo:', err);
                        showToast('Error deleting photo', 'error');
                    });
            }

            // Share photo
            function sharePhoto() {
                if (!currentPhotoId) return;
                
                // First check localStorage
                const localStoragePhotos = JSON.parse(localStorage.getItem('webphoto_library')) || [];
                let photo = localStoragePhotos.find(p => p.id === currentPhotoId);
                
                if (photo) {
                    sharePhotoFile(photo);
                    return;
                }
                
                // If not found in localStorage, check IndexedDB
                if (db) {
                    const transaction = db.transaction(STORE_NAME, 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(currentPhotoId);
                    
                    request.onsuccess = () => {
                        if (request.result) {
                            sharePhotoFile(request.result);
                        } else {
                            showToast('Photo not found', 'error');
                        }
                    };
                    
                    request.onerror = (event) => {
                        showToast('Error loading photo', 'error');
                        console.error('IndexedDB error:', event.target.error);
                    };
                } else {
                    showToast('Photo not found', 'error');
                }
            }

            // Helper to share photo file
            function sharePhotoFile(photo) {
                if (navigator.share) {
                    // Convert data URL to blob
                    fetch(photo.dataUrl)
                        .then(res => res.blob())
                        .then(blob => {
                            const file = new File([blob], photo.name, { type: photo.type });
                            navigator.share({
                                title: 'Check out this photo from my WebPhoto library',
                                text: photo.name,
                                files: [file]
                            }).catch(() => {
                                showToast('Sharing was cancelled', 'info');
                            });
                        })
                        .catch(err => {
                            console.error('Error sharing photo:', err);
                            showToast('Error sharing photo', 'error');
                        });
                } else {
                    // Fallback for browsers that don't support sharing files
                    const shareUrl = `mailto:?subject=Check out this photo&body=${encodeURIComponent(photo.name)} - ${window.location.href}`;
                    window.open(shareUrl, '_blank');
                }
            }

            // Clear all photos
            function clearAllPhotos() {
                const localStoragePhotos = JSON.parse(localStorage.getItem('webphoto_library')) || [];
                if (localStoragePhotos.length === 0) {
                    // Check IndexedDB if localStorage is empty
                    getPhotosFromIndexedDB().then(photos => {
                        if (photos.length === 0) {
                            showToast('Your library is already empty', 'info');
                        } else {
                            confirmClearAll();
                        }
                    }).catch(() => {
                        showToast('Your library is already empty', 'info');
                    });
                } else {
                    confirmClearAll();
                }
            }

            // Confirm and execute clear all
            function confirmClearAll() {
                if (!confirm('Are you sure you want to delete ALL photos? This cannot be undone.')) {
                    return;
                }
                
                // Clear localStorage
                localStorage.removeItem('webphoto_library');
                
                // Clear IndexedDB if it exists
                if (db) {
                    const transaction = db.transaction(STORE_NAME, 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.clear();
                }
                
                loadPhotos();
                updateStorageProgress();
                showToast('All photos have been deleted', 'success');
            }

            // Filter and sort photos
            function filterPhotos() {
                const searchTerm = searchInput.value.toLowerCase();
                const sortValue = sortSelect.value;
                
                // Get photos from both storage sources
                Promise.all([
                    Promise.resolve(JSON.parse(localStorage.getItem('webphoto_library')) || []),
                    db ? getPhotosFromIndexedDB() : Promise.resolve([])
                ]).then(([localPhotos, indexedDBPhotos]) => {
                    // Combine photos (remove duplicates by ID)
                    const allPhotos = [...localPhotos];
                    const indexedDBIds = new Set(localPhotos.map(p => p.id));
                    
                    indexedDBPhotos.forEach(photo => {
                        if (!indexedDBIds.has(photo.id)) {
                            allPhotos.push(photo);
                        }
                    });
                    
                    // Filter
                    let filteredPhotos = allPhotos;
                    if (searchTerm) {
                        filteredPhotos = allPhotos.filter(photo => 
                            photo.name.toLowerCase().includes(searchTerm) || 
                            formatDate(photo.date).toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    // Sort
                    switch (sortValue) {
                        case 'date-desc':
                            filteredPhotos.sort((a, b) => new Date(b.date) - new Date(a.date));
                            break;
                        case 'date-asc':
                            filteredPhotos.sort((a, b) => new Date(a.date) - new Date(b.date));
                            break;
                        case 'name-asc':
                            filteredPhotos.sort((a, b) => a.name.localeCompare(b.name));
                            break;
                        case 'name-desc':
                            filteredPhotos.sort((a, b) => b.name.localeCompare(a.name));
                            break;
                        case 'size-desc':
                            filteredPhotos.sort((a, b) => b.size - a.size);
                            break;
                        case 'size-asc':
                            filteredPhotos.sort((a, b) => a.size - b.size);
                            break;
                    }
                    
                    renderPhotos(filteredPhotos);
                    updatePhotoCounter(filteredPhotos.length);
                }).catch(err => {
                    console.error('Error filtering photos:', err);
                    showToast('Error filtering photos', 'error');
                });
            }

            // Update photo counter
            function updatePhotoCounter(count) {
                Promise.all([
                    Promise.resolve(JSON.parse(localStorage.getItem('webphoto_library')) || []),
                    db ? getPhotosFromIndexedDB() : Promise.resolve([])
                ]).then(([localPhotos, indexedDBPhotos]) => {
                    const totalCount = localPhotos.length + indexedDBPhotos.length;
                    
                    if (searchInput.value) {
                        photoCounter.textContent = count === totalCount 
                            ? `Showing all ${count} photos` 
                            : `Showing ${count} of ${totalCount} photos (filtered)`;
                    } else {
                        photoCounter.textContent = count === 0 
                            ? 'Your photo library is empty' 
                            : `You have ${count} photo${count !== 1 ? 's' : ''} in your library`;
                    }
                });
            }

            // Update storage progress bar
            function updateStorageProgress() {
                if (!navigator.storage || !navigator.storage.estimate) {
                    storageProgress.style.display = 'none';
                    return;
                }
                
                navigator.storage.estimate().then(estimate => {
                    if (estimate.quota && estimate.usage) {
                        const percentage = Math.min(100, (estimate.usage / estimate.quota) * 100);
                        storageProgress.style.width = `${percentage}%`;
                        
                        // Change color based on usage
                        if (percentage > 90) {
                            storageProgress.style.backgroundColor = '#EF4444'; // red
                        } else if (percentage > 70) {
                            storageProgress.style.backgroundColor = '#F59E0B'; // yellow
                        } else {
                            storageProgress.style.backgroundColor = '#4F46E5'; // indigo
                        }
                    }
                }).catch(err => {
                    console.error('Storage estimate error:', err);
                    storageProgress.style.display = 'none';
                });
            }

            // Camera functions
            function openCamera() {
                cameraPreview.classList.add('hidden');
                cameraModal.classList.remove('hidden');
                
                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(s => {
                        stream = s;
                        cameraView.srcObject = stream;
                    })
                    .catch(err => {
                        console.error('Camera error:', err);
                        showToast('Could not access camera: ' + err.message, 'error');
                        closeCamera();
                    });
            }

            function closeCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                cameraModal.classList.add('hidden');
            }

            function capturePhoto() {
                if (!stream) return;
                
                const context = photoCanvas.getContext('2d');
                photoCanvas.width = cameraView.videoWidth;
                photoCanvas.height = cameraView.videoHeight;
                context.drawImage(cameraView, 0, 0, photoCanvas.width, photoCanvas.height);
                
                cameraPreview.classList.remove('hidden');
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            function retakePhoto() {
                cameraPreview.classList.add('hidden');
                openCamera();
            }

            function savePhoto() {
                photoCanvas.toBlob(blob => {
                    const fileName = `webphoto-${new Date().toISOString().slice(0, 10)}.jpg`;
                    const fileSize = blob.size;
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            savePhotoToLibrary({
                                name: fileName,
                                size: fileSize,
                                type: 'image/jpeg',
                                dataUrl: e.target.result,
                                width: img.width,
                                height: img.height,
                                date: new Date().toISOString()
                            }).then(() => {
                                closeCamera();
                                loadPhotos();
                                updateStorageProgress();
                                showToast('Photo saved to your library', 'success');
                            }).catch(err => {
                                console.error('Error saving photo:', err);
                                showToast('Error saving photo (storage might be full)', 'error');
                            });
                        };
                        img.src = e.target.result;
                    };
                    
                    reader.readAsDataURL(blob);
                }, 'image/jpeg', 0.9);
            }

            // Export/Import functions
            function showExportImportModal(mode) {
                if (mode === 'export') {
                    exportImportTitle.textContent = 'Export Photos';
                    exportContent.classList.remove('hidden');
                    importContent.classList.add('hidden');
                    exportResult.classList.add('hidden');
                } else {
                    exportImportTitle.textContent = 'Import Photos';
                    exportContent.classList.add('hidden');
                    importContent.classList.remove('hidden');
                    importProgress.classList.add('hidden');
                }
                exportImportModal.classList.remove('hidden');
            }

            function exportPhotos() {
                // Get all photos from both storage sources
                Promise.all([
                    Promise.resolve(JSON.parse(localStorage.getItem('webphoto_library')) || []),
                    db ? getPhotosFromIndexedDB() : Promise.resolve([])
                ]).then(([localPhotos, indexedDBPhotos]) => {
                    // Combine photos (remove duplicates by ID)
                    const allPhotos = [...localPhotos];
                    const indexedDBIds = new Set(localPhotos.map(p => p.id));
                    
                    indexedDBPhotos.forEach(photo => {
                        if (!indexedDBIds.has(photo.id)) {
                            allPhotos.push(photo);
                        }
                    });
                    
                    if (allPhotos.length === 0) {
                        exportResult.innerHTML = '<p class="text-red-500">Your library is empty - nothing to export</p>';
                        exportResult.classList.remove('hidden');
                        return;
                    }
                    
                    // Create export data
                    const exportData = {
                        version: 1,
                        timestamp: new Date().toISOString(),
                        photoCount: allPhotos.length,
                        photos: allPhotos
                    };
                    
                    // Create download link
                    const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(exportData, null, 2));
                    const downloadAnchor = document.createElement('a');
                    downloadAnchor.setAttribute('href', dataStr);
                    downloadAnchor.setAttribute('download', `webphoto-backup-${new Date().toISOString().slice(0, 10)}.json`);
                    document.body.appendChild(downloadAnchor);
                    downloadAnchor.click();
                    document.body.removeChild(downloadAnchor);
                    
                    exportResult.innerHTML = `<p class="text-green-500">Successfully exported ${allPhotos.length} photos</p>`;
                    exportResult.classList.remove('hidden');
                }).catch(err => {
                    console.error('Export error:', err);
                    exportResult.innerHTML = '<p class="text-red-500">Error exporting photos</p>';
                    exportResult.classList.remove('hidden');
                });
            }

            function handleImport() {
                const file = importFileInput.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        // Validate import data
                        if (!importData.photos || !Array.isArray(importData.photos)) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        importProgress.classList.remove('hidden');
                        importStatus.textContent = `Processing ${importData.photos.length} photos...`;
                        
                        // Process photos in batches to avoid UI freezing
                        const batchSize = 5;
                        let importedCount = 0;
                        let errors = [];
                        
                        function processBatch(startIndex) {
                            const batch = importData.photos.slice(startIndex, startIndex + batchSize);
                            let batchPromises = [];
                            
                            batch.forEach(photo => {
                                // Validate photo structure
                                if (!photo.id || !photo.dataUrl || !photo.name) {
                                    errors.push(`Skipping invalid photo at index ${startIndex + batch.indexOf(photo)}`);
                                    return;
                                }
                                
                                batchPromises.push(
                                    savePhotoToLibrary(photo)
                                        .then(() => {
                                            importedCount++;
                                            updateProgress();
                                        })
                                        .catch(err => {
                                            errors.push(`Failed to import ${photo.name}: ${err.message}`);
                                            updateProgress();
                                        })
                                );
                            });
                            
                            Promise.all(batchPromises).then(() => {
                                const nextIndex = startIndex + batchSize;
                                if (nextIndex < importData.photos.length) {
                                    setTimeout(() => processBatch(nextIndex), 100);
                                } else {
                                    // Import complete
                                    importStatus.textContent = `Imported ${importedCount} of ${importData.photos.length} photos`;
                                    
                                    if (errors.length > 0) {
                                        showToast(`Import completed with ${errors.length} errors`, 'warning');
                                        console.error('Import errors:', errors);
                                    } else {
                                        showToast(`Successfully imported ${importedCount} photos`, 'success');
                                    }
                                    
                                    loadPhotos();
                                    updateStorageProgress();
                                    
                                    // Reset for next import
                                    setTimeout(() => {
                                        importProgress.classList.add('hidden');
                                        importFileInput.value = '';
                                    }, 2000);
                                }
                            });
                        }
                        
                        function updateProgress() {
                            const progress = Math.floor((importedCount + errors.length) / importData.photos.length * 100);
                            importProgressBar.style.width = `${progress}%`;
                            importStatus.textContent = `Imported ${importedCount} of ${importData.photos.length} photos (${progress}%)`;
                        }
                        
                        processBatch(0);
                    } catch (err) {
                        console.error('Import error:', err);
                        importStatus.textContent = 'Error: Invalid backup file format';
                        importProgressBar.style.width = '100%';
                        importProgressBar.style.backgroundColor = '#EF4444';
                        showToast('Invalid backup file', 'error');
                    }
                };
                reader.onerror = function() {
                    importStatus.textContent = 'Error reading file';
                    importProgressBar.style.width = '100%';
                    importProgressBar.style.backgroundColor = '#EF4444';
                    showToast('Error reading backup file', 'error');
                };
                reader.readAsText(file);
            }

            // Helper functions
            function formatDate(dateString, full = false) {
                const date = new Date(dateString);
                if (full) {
                    return date.toLocaleString();
                }
                return date.toLocaleDateString();
            }

            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }

            function showToast(message, type = 'success') {
                toastMessage.textContent = message;
                
                switch (type) {
                    case 'success':
                        toastIcon.className = 'fas fa-check-circle mr-3 text-green-400';
                        break;
                    case 'error':
                        toastIcon.className = 'fas fa-exclamation-circle mr-3 text-red-400';
                        break;
                    case 'info':
                        toastIcon.className = 'fas fa-info-circle mr-3 text-blue-400';
                        break;
                    case 'warning':
                        toastIcon.className = 'fas fa-exclamation-triangle mr-3 text-yellow-400';
                        break;
                }
                
                toast.classList.remove('hidden');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }
        });
    </script>
</body>
</html>